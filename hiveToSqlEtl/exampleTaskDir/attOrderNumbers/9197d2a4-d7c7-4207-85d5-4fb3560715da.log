-- 
-- Query provided by Thomas Ganka
-- Adapted by Ed Soniat to do the previous two days
--
-- Set the number of days AGO here
-- 
SET DAYS_AGO=1;
--
--
SET SECONDS_OFFSET=(86000*${hiveconf:DAYS_AGO});
-- 
--
-- Select the full table of UDES down to just the ones that have the global name "OrderNumber"
-- EXPLAIN 
SELECT session_id,
       visitor_id,
       FROM_UNIXTIME(ROUND(session_time/1000)) AS orig_sess_time,    
       udeValue 
FROM (
--  The hdfs session evts strings have been completely reduced to a table by this select using
--  the GET_JSON_OBJECT. 
    SELECT session_id,
           visitor_id,
           session_time,
           GET_JSON_OBJECT(CONCAT(eventAsJSON, "}"), '$.UDE_GLOBAL_NAME') AS udeGlobalName,
           GET_JSON_OBJECT(CONCAT(eventAsJSON, "}"), '$.UDE_VALUE')       AS udeValue
    FROM (
--         This produces a "table" via the lateral view which has all the UDEs as JSON objects in a 
--         JSON array, prepared for the GET_JSON_OBJECT in the outer select with the LATERAL VIEW,
--         the concat and the replace.
           SELECT session_id,
                  visitor_id,
                  session_time,
--                The fist and last UDE string from session have a [{ and a ]} respectfully and these
--                must be removed.  Also each ude string must be wrapped in {} to form a JSON object
--                so that the outter select can use GET_JSON_OBJECT to find the name and value
                  concat("{",  REGEXP_REPLACE(udeEvents, "\\[\\{|\\}\\]", "")  , "}") eventAsJSON
            FROM (
--                Gets the PUDEValue string from evts as a single string that is not quite JSON and
--                must be split and exploded to view as single UDE event strings.
                  SELECT session_id,
                         visitor_id, 
                         GET_JSON_OBJECT(evts, '$.PVisitorLoginEvent.evts[0].SESSION_START_DT') session_time,
                         GET_JSON_OBJECT(evts, '$.PUDEValue.evts[*]') udeEventString
                         FROM vs_hdfs_v1 
                  WHERE site='76226072' 
                        -- represetn the current time in the same format as day eg 20130130
                        AND day > FROM_unixTime(unix_timestamp() - ${hiveconf:SECONDS_OFFSET},'yyyyMMdd')
            ) sessionsUdeEvts   
--          This splits the udeEvent string around the },{, explodes it and makes a table of strings.
--          Each line in this lateral view table is a singe UDE event, the first and last have a [{ and {]
--          espectively that are cleaned up in the select out side of this one.
            LATERAL VIEW EXPLODE(SPLIT( udeEventString, "\\},\\{")) adTable AS udeEvents
    ) sessionJSONUdeEvents 
) sessionAllUDETable
WHERE udeGlobalName in ('OrderNumber');
   Hive history file=/tmp/esoniat/hive_job_log_esoniat_201306070909_1164348408.txt
Total MapReduce jobs = 1
Launching Job 1 out of 1
Number of reduce tasks is set to 0 since there's no reduce operator
Starting Job = job_201306060848_12728, Tracking URL = http://vvpr-mha01:50030/jobdetails.jsp?jobid=job_201306060848_12728
Kill Command = /usr/lib/hadoop/bin/hadoop job  -Dmapred.job.tracker=vvpr-mha01:54311 -kill job_201306060848_12728
2013-06-07 09:10:45,244 Stage-1 map = 0%,  reduce = 0%
2013-06-07 09:11:46,311 Stage-1 map = 0%,  reduce = 0%
2013-06-07 09:12:12,833 Stage-1 map = 1%,  reduce = 0%
2013-06-07 09:13:13,217 Stage-1 map = 1%,  reduce = 0%
2013-06-07 09:13:55,437 Stage-1 map = 2%,  reduce = 0%
2013-06-07 09:14:55,847 Stage-1 map = 2%,  reduce = 0%
2013-06-07 09:15:34,350 Stage-1 map = 3%,  reduce = 0%
2013-06-07 09:16:34,783 Stage-1 map = 3%,  reduce = 0%
2013-06-07 09:17:30,133 Stage-1 map = 4%,  reduce = 0%
2013-06-07 09:18:30,796 Stage-1 map = 4%,  reduce = 0%
2013-06-07 09:19:01,098 Stage-1 map = 5%,  reduce = 0%
2013-06-07 09:20:01,127 Stage-1 map = 5%,  reduce = 0%
2013-06-07 09:20:33,986 Stage-1 map = 6%,  reduce = 0%
2013-06-07 09:21:35,128 Stage-1 map = 6%,  reduce = 0%
2013-06-07 09:22:20,643 Stage-1 map = 7%,  reduce = 0%
2013-06-07 09:23:21,828 Stage-1 map = 7%,  reduce = 0%
2013-06-07 09:23:41,034 Stage-1 map = 8%,  reduce = 0%
2013-06-07 09:24:41,412 Stage-1 map = 9%,  reduce = 0%
2013-06-07 09:25:42,034 Stage-1 map = 9%,  reduce = 0%
2013-06-07 09:25:45,327 Stage-1 map = 10%,  reduce = 0%
2013-06-07 09:26:44,353 Stage-1 map = 11%,  reduce = 0%
2013-06-07 09:27:45,225 Stage-1 map = 11%,  reduce = 0%
2013-06-07 09:28:17,134 Stage-1 map = 12%,  reduce = 0%
2013-06-07 09:29:17,213 Stage-1 map = 12%,  reduce = 0%
2013-06-07 09:29:48,195 Stage-1 map = 13%,  reduce = 0%
2013-06-07 09:30:48,801 Stage-1 map = 13%,  reduce = 0%
2013-06-07 09:31:12,255 Stage-1 map = 14%,  reduce = 0%
2013-06-07 09:32:12,809 Stage-1 map = 14%,  reduce = 0%
2013-06-07 09:32:42,875 Stage-1 map = 15%,  reduce = 0%
2013-06-07 09:33:43,009 Stage-1 map = 15%,  reduce = 0%
2013-06-07 09:34:04,724 Stage-1 map = 16%,  reduce = 0%
2013-06-07 09:35:04,839 Stage-1 map = 16%,  reduce = 0%
2013-06-07 09:35:36,028 Stage-1 map = 17%,  reduce = 0%
2013-06-07 09:36:36,164 Stage-1 map = 17%,  reduce = 0%
2013-06-07 09:36:57,098 Stage-1 map = 18%,  reduce = 0%
2013-06-07 09:37:58,153 Stage-1 map = 18%,  reduce = 0%
2013-06-07 09:38:03,893 Stage-1 map = 19%,  reduce = 0%
2013-06-07 09:39:05,548 Stage-1 map = 19%,  reduce = 0%
2013-06-07 09:39:25,205 Stage-1 map = 20%,  reduce = 0%
2013-06-07 09:40:25,261 Stage-1 map = 20%,  reduce = 0%
2013-06-07 09:40:52,375 Stage-1 map = 21%,  reduce = 0%
2013-06-07 09:41:52,572 Stage-1 map = 21%,  reduce = 0%
2013-06-07 09:42:44,450 Stage-1 map = 22%,  reduce = 0%
2013-06-07 09:43:44,570 Stage-1 map = 22%,  reduce = 0%
2013-06-07 09:44:32,883 Stage-1 map = 23%,  reduce = 0%
2013-06-07 09:45:33,038 Stage-1 map = 23%,  reduce = 0%
2013-06-07 09:46:34,395 Stage-1 map = 23%,  reduce = 0%
2013-06-07 09:46:48,679 Stage-1 map = 24%,  reduce = 0%
2013-06-07 09:47:49,056 Stage-1 map = 24%,  reduce = 0%
2013-06-07 09:48:09,420 Stage-1 map = 25%,  reduce = 0%
2013-06-07 09:49:10,319 Stage-1 map = 25%,  reduce = 0%
2013-06-07 09:49:51,056 Stage-1 map = 26%,  reduce = 0%
2013-06-07 09:50:51,457 Stage-1 map = 26%,  reduce = 0%
2013-06-07 09:51:52,365 Stage-1 map = 26%,  reduce = 0%
2013-06-07 09:51:58,251 Stage-1 map = 27%,  reduce = 0%
2013-06-07 09:52:59,279 Stage-1 map = 27%,  reduce = 0%
2013-06-07 09:53:59,433 Stage-1 map = 27%,  reduce = 0%
2013-06-07 09:54:00,608 Stage-1 map = 28%,  reduce = 0%
2013-06-07 09:55:01,206 Stage-1 map = 28%,  reduce = 0%
2013-06-07 09:56:04,575 Stage-1 map = 28%,  reduce = 0%
2013-06-07 09:56:17,181 Stage-1 map = 29%,  reduce = 0%
2013-06-07 09:57:18,087 Stage-1 map = 29%,  reduce = 0%
2013-06-07 09:58:18,602 Stage-1 map = 30%,  reduce = 0%
2013-06-07 09:59:22,256 Stage-1 map = 30%,  reduce = 0%
2013-06-07 09:59:57,296 Stage-1 map = 31%,  reduce = 0%
2013-06-07 10:00:57,344 Stage-1 map = 31%,  reduce = 0%
2013-06-07 10:01:34,670 Stage-1 map = 32%,  reduce = 0%
2013-06-07 10:02:35,134 Stage-1 map = 32%,  reduce = 0%
2013-06-07 10:02:52,908 Stage-1 map = 33%,  reduce = 0%
2013-06-07 10:03:53,272 Stage-1 map = 34%,  reduce = 0%
2013-06-07 10:04:54,310 Stage-1 map = 34%,  reduce = 0%
2013-06-07 10:05:13,343 Stage-1 map = 35%,  reduce = 0%
2013-06-07 10:06:08,391 Stage-1 map = 36%,  reduce = 0%
2013-06-07 10:06:52,405 Stage-1 map = 37%,  reduce = 0%
2013-06-07 10:07:40,736 Stage-1 map = 38%,  reduce = 0%
2013-06-07 10:08:25,550 Stage-1 map = 39%,  reduce = 0%
2013-06-07 10:09:11,334 Stage-1 map = 40%,  reduce = 0%
2013-06-07 10:10:11,684 Stage-1 map = 41%,  reduce = 0%
2013-06-07 10:11:12,775 Stage-1 map = 41%,  reduce = 0%
2013-06-07 10:11:18,481 Stage-1 map = 42%,  reduce = 0%
2013-06-07 10:12:19,950 Stage-1 map = 42%,  reduce = 0%
2013-06-07 10:12:29,331 Stage-1 map = 43%,  reduce = 0%
2013-06-07 10:13:31,096 Stage-1 map = 43%,  reduce = 0%
2013-06-07 10:13:48,614 Stage-1 map = 44%,  reduce = 0%
2013-06-07 10:14:49,659 Stage-1 map = 44%,  reduce = 0%
2013-06-07 10:15:07,542 Stage-1 map = 45%,  reduce = 0%
2013-06-07 10:16:07,679 Stage-1 map = 45%,  reduce = 0%
2013-06-07 10:16:34,476 Stage-1 map = 46%,  reduce = 0%
2013-06-07 10:17:35,946 Stage-1 map = 46%,  reduce = 0%
2013-06-07 10:17:59,344 Stage-1 map = 47%,  reduce = 0%
2013-06-07 10:18:59,862 Stage-1 map = 47%,  reduce = 0%
2013-06-07 10:19:01,107 Stage-1 map = 48%,  reduce = 0%
2013-06-07 10:20:01,131 Stage-1 map = 48%,  reduce = 0%
2013-06-07 10:20:26,078 Stage-1 map = 49%,  reduce = 0%
2013-06-07 10:21:28,026 Stage-1 map = 49%,  reduce = 0%
2013-06-07 10:22:02,398 Stage-1 map = 50%,  reduce = 0%
2013-06-07 10:23:03,468 Stage-1 map = 50%,  reduce = 0%
2013-06-07 10:24:03,614 Stage-1 map = 50%,  reduce = 0%
2013-06-07 10:24:35,497 Stage-1 map = 51%,  reduce = 0%
2013-06-07 10:25:36,531 Stage-1 map = 51%,  reduce = 0%
2013-06-07 10:26:20,268 Stage-1 map = 52%,  reduce = 0%
2013-06-07 10:27:21,412 Stage-1 map = 52%,  reduce = 0%
2013-06-07 10:27:41,291 Stage-1 map = 53%,  reduce = 0%
2013-06-07 10:28:42,296 Stage-1 map = 53%,  reduce = 0%
2013-06-07 10:28:43,586 Stage-1 map = 54%,  reduce = 0%
2013-06-07 10:29:38,867 Stage-1 map = 55%,  reduce = 0%
2013-06-07 10:30:31,995 Stage-1 map = 56%,  reduce = 0%
2013-06-07 10:31:30,217 Stage-1 map = 57%,  reduce = 0%
2013-06-07 10:32:32,313 Stage-1 map = 58%,  reduce = 0%
2013-06-07 10:33:33,220 Stage-1 map = 58%,  reduce = 0%
2013-06-07 10:33:39,266 Stage-1 map = 59%,  reduce = 0%
2013-06-07 10:34:42,392 Stage-1 map = 60%,  reduce = 0%
2013-06-07 10:35:43,787 Stage-1 map = 60%,  reduce = 0%
2013-06-07 10:35:45,308 Stage-1 map = 61%,  reduce = 0%
2013-06-07 10:36:45,450 Stage-1 map = 61%,  reduce = 0%
2013-06-07 10:36:56,721 Stage-1 map = 62%,  reduce = 0%
2013-06-07 10:38:00,561 Stage-1 map = 62%,  reduce = 0%
2013-06-07 10:38:02,033 Stage-1 map = 63%,  reduce = 0%
2013-06-07 10:39:02,412 Stage-1 map = 63%,  reduce = 0%
2013-06-07 10:39:08,731 Stage-1 map = 64%,  reduce = 0%
2013-06-07 10:40:02,823 Stage-1 map = 65%,  reduce = 0%
2013-06-07 10:41:15,263 Stage-1 map = 66%,  reduce = 0%
2013-06-07 10:42:16,487 Stage-1 map = 66%,  reduce = 0%
2013-06-07 10:43:05,395 Stage-1 map = 67%,  reduce = 0%
2013-06-07 10:44:06,569 Stage-1 map = 67%,  reduce = 0%
2013-06-07 10:45:06,715 Stage-1 map = 68%,  reduce = 0%
2013-06-07 10:46:08,179 Stage-1 map = 68%,  reduce = 0%
2013-06-07 10:46:46,554 Stage-1 map = 69%,  reduce = 0%
2013-06-07 10:47:48,467 Stage-1 map = 69%,  reduce = 0%
2013-06-07 10:48:36,012 Stage-1 map = 70%,  reduce = 0%
2013-06-07 10:49:37,270 Stage-1 map = 70%,  reduce = 0%
2013-06-07 10:50:21,464 Stage-1 map = 71%,  reduce = 0%
2013-06-07 10:51:22,133 Stage-1 map = 71%,  reduce = 0%
2013-06-07 10:51:54,569 Stage-1 map = 72%,  reduce = 0%
2013-06-07 10:52:56,070 Stage-1 map = 72%,  reduce = 0%
2013-06-07 10:53:30,028 Stage-1 map = 73%,  reduce = 0%
2013-06-07 10:54:30,262 Stage-1 map = 73%,  reduce = 0%
2013-06-07 10:55:10,695 Stage-1 map = 74%,  reduce = 0%
2013-06-07 10:56:11,800 Stage-1 map = 74%,  reduce = 0%
2013-06-07 10:57:01,366 Stage-1 map = 75%,  reduce = 0%
2013-06-07 10:58:02,179 Stage-1 map = 75%,  reduce = 0%
2013-06-07 10:59:02,301 Stage-1 map = 75%,  reduce = 0%
2013-06-07 10:59:05,194 Stage-1 map = 76%,  reduce = 0%
2013-06-07 11:00:06,214 Stage-1 map = 76%,  reduce = 0%
2013-06-07 11:01:07,211 Stage-1 map = 76%,  reduce = 0%
2013-06-07 11:01:08,757 Stage-1 map = 77%,  reduce = 0%
2013-06-07 11:02:09,986 Stage-1 map = 77%,  reduce = 0%
2013-06-07 11:03:11,001 Stage-1 map = 77%,  reduce = 0%
2013-06-07 11:03:51,362 Stage-1 map = 78%,  reduce = 0%
2013-06-07 11:04:52,130 Stage-1 map = 78%,  reduce = 0%
2013-06-07 11:05:34,013 Stage-1 map = 79%,  reduce = 0%
2013-06-07 11:06:34,276 Stage-1 map = 79%,  reduce = 0%
2013-06-07 11:07:05,626 Stage-1 map = 80%,  reduce = 0%
2013-06-07 11:08:05,832 Stage-1 map = 80%,  reduce = 0%
2013-06-07 11:09:06,538 Stage-1 map = 80%,  reduce = 0%
2013-06-07 11:09:08,344 Stage-1 map = 81%,  reduce = 0%
2013-06-07 11:10:09,458 Stage-1 map = 81%,  reduce = 0%
2013-06-07 11:11:10,036 Stage-1 map = 81%,  reduce = 0%
2013-06-07 11:11:23,630 Stage-1 map = 82%,  reduce = 0%
2013-06-07 11:12:25,275 Stage-1 map = 82%,  reduce = 0%
2013-06-07 11:13:25,393 Stage-1 map = 82%,  reduce = 0%
2013-06-07 11:13:39,135 Stage-1 map = 83%,  reduce = 0%
2013-06-07 11:14:42,651 Stage-1 map = 83%,  reduce = 0%
2013-06-07 11:15:31,806 Stage-1 map = 84%,  reduce = 0%
2013-06-07 11:16:32,572 Stage-1 map = 84%,  reduce = 0%
2013-06-07 11:16:49,163 Stage-1 map = 85%,  reduce = 0%
2013-06-07 11:17:50,438 Stage-1 map = 85%,  reduce = 0%
2013-06-07 11:18:16,894 Stage-1 map = 86%,  reduce = 0%
2013-06-07 11:19:17,814 Stage-1 map = 86%,  reduce = 0%
2013-06-07 11:19:43,905 Stage-1 map = 87%,  reduce = 0%
2013-06-07 11:20:46,411 Stage-1 map = 87%,  reduce = 0%
2013-06-07 11:21:48,851 Stage-1 map = 87%,  reduce = 0%
2013-06-07 11:22:02,780 Stage-1 map = 88%,  reduce = 0%
2013-06-07 11:23:08,342 Stage-1 map = 88%,  reduce = 0%
2013-06-07 11:24:08,419 Stage-1 map = 88%,  reduce = 0%
2013-06-07 11:24:12,802 Stage-1 map = 89%,  reduce = 0%
2013-06-07 11:25:14,965 Stage-1 map = 89%,  reduce = 0%
2013-06-07 11:26:07,835 Stage-1 map = 90%,  reduce = 0%
2013-06-07 11:27:07,940 Stage-1 map = 90%,  reduce = 0%
2013-06-07 11:28:08,909 Stage-1 map = 90%,  reduce = 0%
2013-06-07 11:28:32,006 Stage-1 map = 91%,  reduce = 0%
2013-06-07 11:29:33,468 Stage-1 map = 91%,  reduce = 0%
2013-06-07 11:30:01,871 Stage-1 map = 92%,  reduce = 0%
2013-06-07 11:31:04,511 Stage-1 map = 92%,  reduce = 0%
2013-06-07 11:31:08,854 Stage-1 map = 93%,  reduce = 0%
2013-06-07 11:32:14,030 Stage-1 map = 93%,  reduce = 0%
2013-06-07 11:32:26,221 Stage-1 map = 94%,  reduce = 0%
2013-06-07 11:33:28,441 Stage-1 map = 94%,  reduce = 0%
2013-06-07 11:33:38,998 Stage-1 map = 95%,  reduce = 0%
2013-06-07 11:34:39,629 Stage-1 map = 95%,  reduce = 0%
2013-06-07 11:34:41,077 Stage-1 map = 96%,  reduce = 0%
2013-06-07 11:35:42,409 Stage-1 map = 96%,  reduce = 0%
2013-06-07 11:36:45,045 Stage-1 map = 96%,  reduce = 0%
2013-06-07 11:37:47,550 Stage-1 map = 96%,  reduce = 0%
2013-06-07 11:38:30,596 Stage-1 map = 97%,  reduce = 0%
2013-06-07 11:39:31,502 Stage-1 map = 97%,  reduce = 0%
2013-06-07 11:40:32,330 Stage-1 map = 97%,  reduce = 0%
2013-06-07 11:40:59,979 Stage-1 map = 98%,  reduce = 0%
2013-06-07 11:42:00,648 Stage-1 map = 98%,  reduce = 0%
2013-06-07 11:43:00,808 Stage-1 map = 98%,  reduce = 0%
2013-06-07 11:44:01,465 Stage-1 map = 98%,  reduce = 0%
2013-06-07 11:44:35,347 Stage-1 map = 99%,  reduce = 0%
2013-06-07 11:45:36,397 Stage-1 map = 99%,  reduce = 0%
2013-06-07 11:46:36,786 Stage-1 map = 99%,  reduce = 0%
2013-06-07 11:47:38,659 Stage-1 map = 99%,  reduce = 0%
2013-06-07 11:48:22,547 Stage-1 map = 100%,  reduce = 0%
2013-06-07 11:49:23,175 Stage-1 map = 100%,  reduce = 0%
2013-06-07 11:50:23,625 Stage-1 map = 100%,  reduce = 0%
2013-06-07 11:50:48,055 Stage-1 map = 100%,  reduce = 100%
Ended Job = job_201306060848_12728
OK
Time taken: 9718.533 seconds
